trigger:
  - main
  - refs/tags/*

pr:
  - main
  
variables:
  BUILD_NUMBER: $(Build.BuildNumber)
  BUILD_COMMIT: $(Build.SourceVersion)
  ComponentDetection.Timeout: 1200

  # Build variables
  mainBranchName: main                                                                  # Name of Git "main" branch
  configuration: Release                                                                # Build configuration: 'Debug', 'Release'

  # Windows specific variables
  windowsAgentPoolName: Maui-1ESPT                                                      # Windows VM pool name
  windowsImage: 1ESPT-Windows2022                                                       # Windows VM image name
  windowsClassicInstaller: https://aka.ms/xamarin-android-commercial-d17-8-windows      # Windows Classic XA installer URL
  
  # macOS specific variables
  macosAgentPoolName: Azure Pipelines                                                   # macOS VM pool name
  macosImage: internal-macos12                                                          # macOS VM image name
  macosClassicInstaller:  https://aka.ms/xamarin-android-commercial-d17-8-macos         # macOS Classic XA installer URL

resources:
  repositories:
    - repository: 1esPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release
    - repository: internal-templates
      type: github
      name: xamarin/yaml-templates
      endpoint: xamarin
      ref: refs/heads/main
    - repository: androidx
      type: github
      name: xamarin/androidx
      endpoint: xamarin
      ref: refs/heads/no-classic

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines
  parameters:   
    pool:
      name: AzurePipelines-EO
      image: 1ESPT-Windows2022
      os: windows
      
    stages:
    - stage: Build

      jobs:
      - template: build/ci/build.yml@androidx
        parameters:
          name: windows
          buildPool:
            name: $(windowsAgentPoolName)
            image: $(windowsImage)
            os: windows
          classicInstallerUrl: $(windowsClassicInstaller)
          mainBranchName: $(mainBranchName)
          configuration: $(configuration)
          runAPIScan: true
          skipUnitTests: true
          timeoutInMinutes: 300

      - template: build/ci/build.yml@androidx
        parameters:
          name: macos
          buildPool:
            name: $(macosAgentPoolName)
            vmImage: $(macosImage)
            os: macOS
          classicInstallerUrl: $(macosClassicInstaller)
          mainBranchName: $(mainBranchName)
          configuration: $(configuration)
          skipUnitTests: true
          timeoutInMinutes: 300

      - template: sign-artifacts/jobs/v2.yml@internal-templates
        parameters:
          dependsOn: [ 'build_windows' ]
          artifactName: output-windows
          usePipelineArtifactTasks: true
          use1ESTemplate: true
          condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/')
